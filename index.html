<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D-Team Elite Hub</title>
    <style>
        :root { --bg: #0f1111; --card: #232f3e; --accent: #febd69; --text: #ffffff; --r: #ff4d4d; --y: #f1c40f; --g: #00ff88; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        h1 { font-size: 16px; margin: 0; color: var(--accent); font-weight: 800; }
        input[type="date"] { background: #3a4553; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 4px; font-size: 14px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; table-layout: fixed; }
        th { font-size: 10px; color: #888; font-weight: normal; text-align: center; }
        td { background: var(--card); padding: 12px 2px; text-align: center; border: none; }
        td:first-child { border-radius: 6px 0 0 6px; }
        td:last-child { border-radius: 0 6px 6px 0; }
        
        .name { font-size: 13px; font-weight: bold; text-align: left; padding-left: 10px; color: var(--accent); text-decoration: underline; white-space: nowrap; overflow: hidden; }
        input[type="number"] { width: 85%; background: #131a22; color: #fff; border: 1px solid #3a4553; border-radius: 4px; padding: 8px 0; text-align: center; font-size: 16px; -webkit-appearance: none; }
        
        .sc { font-size: 20px; font-weight: 900; }
        .rank-high { color: var(--g); }
        .rank-mid { color: var(--y); }
        .rank-low { color: var(--r); }

        .btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        button { padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-csv { background: #3a4553; color: #fff; }

        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-cont { background: #1a1a1a; width: 90%; max-height: 80%; border-radius: 12px; padding: 20px; border: 1px solid var(--accent); box-sizing: border-box; overflow-y: auto; }
        .modal-close { display: block; text-align: right; color: var(--accent); font-weight: bold; margin-bottom: 15px; }
        .hist-table { width: 100%; font-size: 12px; border-collapse: collapse; }
        .hist-table th, .hist-table td { border-bottom: 1px solid #333; padding: 8px 4px; text-align: center; }
    </style>
</head>
<body>

<div id="modal" onclick="closeModal()">
    <div class="modal-cont" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal()">✕ 閉じる</span>
        <h3 id="m-name" style="color:var(--accent); margin-top:0;"></h3>
        <div id="m-history"></div>
    </div>
</div>

<div class="header">
    <h1>D-TEAM ELITE HUB</h1>
    <input type="date" id="date-pick" onchange="loadDay()">
</div>

<table>
    <thead>
        <tr>
            <th style="width:25%">氏名(タップ履歴)</th>
            <th style="width:16%">未配</th>
            <th style="width:16%">誤配</th>
            <th style="width:19%">Mentor</th>
            <th style="width:24%">当日点</th>
        </tr>
    </thead>
    <tbody id="list"></tbody>
</table>

<div class="btns">
    <button class="btn-save" onclick="saveData()">データを保存</button>
    <button class="btn-csv" onclick="exportCSV()">CSV出力</button>
</div>

<script>
let members = [
    {id:0, name: "西村拓馬"}, {id:1, name: "高橋秀彪"}, 
    {id:2, name: "梅村安広"}, {id:3, name: "金子亨"}, 
    {id:4, name: "新里裕"}, {id:5, name: "山口香月"}
];
let db = JSON.parse(localStorage.getItem('dTeamEliteDB_v3')) || {};
let isEditing = false; // 入力中フラグ

document.getElementById('date-pick').valueAsDate = new Date();

function calcScore(m, g, f) {
    let mPoint = 0;
    if (f >= 800) {
        mPoint = 75 + (f - 800); 
    } else if (f >= 750) {
        mPoint = (f - 750) * 1.5; 
    }
    let penalty = (g * 50) + (m * 20);
    let total = mPoint - penalty;
    return Math.max(0, Math.min(100, Math.round(total * 10) / 10));
}

// 画面描画（並べ替えあり）
function render(sort = true) {
    if (isEditing) return; // 入力中は描画更新をブロック

    const tbody = document.getElementById('list');
    let currentData = [];

    members.forEach(member => {
        const date = document.getElementById('date-pick').value;
        // メモリ内の一時データがあれば優先、なければDB、なければ初期値
        const saved = (db[date] && db[date][member.id]) ? db[date][member.id] : {m:0, g:0, f:750};
        const m = saved.m;
        const g = saved.g;
        const f = saved.f;
        const score = calcScore(m, g, f);
        currentData.push({ ...member, m, g, f, score });
    });

    if (sort) {
        currentData.sort((a, b) => b.score - a.score);
    }

    tbody.innerHTML = '';
    currentData.forEach(d => {
        let colorClass = d.score >= 80 ? 'rank-high' : (d.score >= 60 ? 'rank-mid' : (d.score <= 40 ? 'rank-low' : ''));
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="name" onclick="showHistory(${d.id})">${d.name}</td>
            <td><input type="number" value="${d.m}" onfocus="isEditing=true" onblur="updateVal(${d.id}, 'm', this.value)" oninput="fastUpdate(${d.id}, this)"></td>
            <td><input type="number" value="${d.g}" onfocus="isEditing=true" onblur="updateVal(${d.id}, 'g', this.value)" oninput="fastUpdate(${d.id}, this)"></td>
            <td><input type="number" value="${d.f}" onfocus="isEditing=true" onblur="updateVal(${d.id}, 'f', this.value)" oninput="fastUpdate(${d.id}, this)"></td>
            <td id="score-${d.id}" class="sc ${colorClass}">${d.score}</td>
        `;
        tbody.appendChild(tr);
    });
}

// 入力中の数値計算のみを即時反映（並べ替えはしない）
function fastUpdate(id, el) {
    const row = el.closest('tr');
    const m = row.querySelectorAll('input')[0].value;
    const g = row.querySelectorAll('input')[1].value;
    const f = row.querySelectorAll('input')[2].value;
    const score = calcScore(m, g, f);
    const scoreEl = document.getElementById(`score-${id}`);
    scoreEl.innerText = score;
    scoreEl.className = `sc ${score >= 80 ? 'rank-high' : (score >= 60 ? 'rank-mid' : (score <= 40 ? 'rank-low' : ''))}`;
}

// フォーカスが外れた時にデータを一時保持
function updateVal(id, type, val) {
    isEditing = false;
    const date = document.getElementById('date-pick').value;
    if (!db[date]) db[date] = {};
    if (!db[date][id]) db[date][id] = {m:0, g:0, f:750};
    db[date][id][type] = val;
    // 数秒後に並べ替えを実行（連続入力の邪魔をしないため）
    clearTimeout(window.sortTimer);
    window.sortTimer = setTimeout(() => { render(true); }, 1500);
}

function saveData() {
    localStorage.setItem('dTeamEliteDB_v3', JSON.stringify(db));
    alert("全データを保存しました。");
    render(true);
}

function loadDay() {
    isEditing = false;
    render(true);
}

function showHistory(id) {
    const member = members.find(m => m.id === id);
    document.getElementById('m-name').innerText = member.name + " 履歴";
    let html = '<table class="hist-table"><tr><th>日付</th><th>未</th><th>誤</th><th>Men</th><th>点</th></tr>';
    const sortedDates = Object.keys(db).sort().reverse();
    if (sortedDates.length === 0) html += '<tr><td colspan="5">データなし</td></tr>';
    sortedDates.forEach(date => {
        const d = db[date][id];
        if(d) html += `<tr><td>${date.slice(5)}</td><td>${d.m}</td><td>${d.g}</td><td>${d.f}</td><td>${d.s || calcScore(d.m, d.g, d.f)}</td></tr>`;
    });
    document.getElementById('m-history').innerHTML = html + '</table>';
    document.getElementById('modal').style.display = 'flex';
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

function exportCSV() {
    let csv = "日付,氏名,未配,誤配,Mentor,当日点\n";
    Object.keys(db).sort().forEach(date => {
        members.forEach(m => {
            const d = db[date][m.id];
            if(d) csv += `${date},${m.name},${d.m},${d.g},${d.f},${calcScore(d.m, d.g, d.f)}\n`;
        });
    });
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `D-Team-Report.csv`;
    link.click();
}

window.onload = () => { render(true); };
</script>
</body>
</html>
